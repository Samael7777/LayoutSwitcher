<html style><!--
 Page saved with SingleFile 
 url: http://archives.miloush.net/michkap/archive/2006/05/16/598980.html 
 saved date: Wed Jan 17 2024 22:11:16 GMT+0100 (Центральная Европа, стандартное время)
--><meta charset=utf-8><meta name=viewport content="width=device-width"><title>What broke the input language messages?</title><meta name=referrer content=no-referrer><link rel=canonical href=http://archives.miloush.net/michkap/archive/2006/05/16/598980.html><meta http-equiv=content-security-policy content="default-src 'none'; font-src 'self' data:; img-src 'self' data:; style-src 'unsafe-inline'; media-src 'self' data:; script-src 'unsafe-inline' data:; object-src 'self' data:; frame-src 'self' data:;"><style>img[src="data:,"],source[src="data:,"]{display:none!important}</style><body>
<h1>What broke the input language messages?</h1>
<p><em>by Michael S. Kaplan, published on 2006/05/16 11:40 -04:00, original URI: http://blogs.msdn.com/b/michkap/archive/2006/05/16/598980.aspx</em></p>
<hr> 
<p><font face=Tahoma>Yesterday, when I was talking about the role of input language change events and how <strong><a href=http://archives.miloush.net/michkap/archive/2006/05/15/598548.html>Even if the message is not for you, you still need to pass it on</a></strong>, I dangled a small morsel at the end:</font></p>
<blockquote dir=ltr style=MARGIN-RIGHT:0px>
<p><font face="Times New Roman" size=2>Now in fairness, the above deterministic process stopped being 100% true all the time starting with Windows XP; this is an issue that is for the most part by design but does not appear to be in any of the documentation. I'll explain what broke the model and why (as well as how to keep things working properly!) tomorrow....</font></p></blockquote>
<p><font face=Tahoma>It is not nice to tease the readers, so I will explain what changed in XP and when....</font></p>
<p><font face=Tahoma>Basically there are two changes that happened, both of which affect <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/text_services_framework.asp>Text Services Framework</a> (TSF) members, known as Text Services (defined in the glossary as</font></p>
<blockquote dir=ltr style=MARGIN-RIGHT:0px>
<p><font face=Tahoma size=2>An application type that enables text input by way of speech, multilanguage keyboard, or pen device. A text service can also enable text editing tools such as spelling and grammar checking.</font></p></blockquote>
<p><font face=Tahoma>What changed is some of the behavior of the Language Bar (which became a fully programmable COM object that is documented in MSDN <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/language_bar.asp>here</a>).</font></p>
<p><font face=Tahoma>The specific changes that affect it are:</font></p>
<ul>
<li><font face=Tahoma>The <a href=http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowmessages/wm_inputlangchangerequest.asp>WM_INPUTLANGCHANGEREQUEST</a> message is not posted when current input language is changed to a TSF Text&nbsp;Service;</font></li>
<li><font face=Tahoma>Even the <a href=http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowmessages/wm_inputlangchange.asp>WM_INPUTLANGCHANGE</a> message is not sent if a TSF Text Service has already been activated in the thread (i.e. if you switch to it, switch to something else, and then switch back to it).</font></ul>
<p><font face=Tahoma>The guy in charge of TSF on the program management side mentioned to me a few years back that the reason for the change was that there were many applications that were blocking keyboards (either by not passing messages on or by not seeing them on some arbitrary list), which would actually break the support for all of the new text services when the user had specified that they wanted them working everywhere:</font></p>
<p><img height=478 src=data:, width=404></p>
<p><font face=Tahoma><em>(There may or may not a flaw or two in the logic there, but that conversation can wait for another day....)</em></font></p>
<p><font face=Tahoma>Now many of the Input Method Editors were converted to TSF Text Services, and of course anyone can write their own (links to several samples <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/text_services_framework.asp>here</a>). In Vista several more IMEs were converted and at least two languages that need input methods that are more complicated than a regular keyboard even if less complicated than a full IME also received TSF Text Services.</font></p>
<p><font face=Tahoma>The upshot? Those two USER messages can no longer be relied on at all, for an unbounded list of possible input languages....</font></p>
<p><font face=Tahoma>The replacement which will work for both regular keyboards and TSF Text Services is the <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itflanguageprofilenotifysink.asp>ITfLanguageProfileNotifySink</a> interface and its two methods:</font></p>
<ul>
<li><font face=Tahoma><a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itflanguageprofilenotifysink_onlanguagechange.asp>OnLanguageChange</a> - Called when the language profile is about to change.</font></li>
<li><font face=Tahoma><a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itflanguageprofilenotifysink_onlanguagechanged.asp>OnLanguageChanged</a> - Called after the language profile has changed.</font></ul>
<p><font face=Tahoma>Now&nbsp;the first method only returns a LANGID and the second returns nothing at all (an HKL is all&nbsp;the old USER messages returned, an HKLs are not needed in the TSF world);&nbsp;if you want to know what the change actually is beyond a LANGID, you&nbsp;can use the <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itfinputprocessorprofiles.asp>ITfInputProcessorProfiles</a> interface and its <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itfinputprocessorprofiles_getactivelanguageprofile.asp>GetActiveLanguageProfile</a> method. This method will return the GUID that is used to&nbsp;identify the specific text service.</font></p>
<p><font face=Tahoma>Where that gets you is of course an even more complicated matter -- since there is really nothing publically available other than <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/text_services_framework.asp>those nine samples</a>, and none of them cover the bulk of these language bar issues. :-(</font></p>
<p><font face=Tahoma>Though if you want a nice simple way to get at this stuff (which the documentation explains but does not recommend since you have to do your own refcounting rather than letting COM do it!), you can call <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/tf_createthreadmgr.asp>TF_CreateThreadManager</a>; this will give you an <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itfthreadmgr.asp>ITfThreadMgr</a>, from which you can QI an <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itfsource.asp>ITfSource</a>. And you can install an advise sink via <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itfsource_advisesink.asp>AdviseSink</a>&nbsp;to get an also handy <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itfactivelanguageprofilenotifysink.asp>ITfActiveLanguageProfileNotifySink</a>&nbsp;that will tell you when the active language or text service has changed, via its <a href=http://msdn.microsoft.com/library/en-us/tsf/tsf/itfactivelanguageprofilenotifysink_onactivated.asp>OnActivated</a> method -- which does not give the language information (so you have to make other calls to&nbsp;find out what was changed to anyway!).</font></p>
<p><font face=Tahoma>If there was ever an area that needed more samples, this would really be it, I think. While there are a few folks out there like <a href=http://www.tavultesoft.com/keyman/>Tavultesoft</a> and <a href=http://murasu.com/>Murasu</a> who have puzzled it out, there would be a lot more if there were more samples out there.</font></p>
<p><font face=Tahoma>And in the meantime, it might make sense to update the docs for <a href=http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowmessages/wm_inputlangchangerequest.asp>WM_INPUTLANGCHANGEREQUEST</a> and&nbsp;<font face=Tahoma><a href=http://msdn.microsoft.com/library/en-us/winui/winui/windowsuserinterface/windowing/windows/windowreference/windowmessages/wm_inputlangchange.asp>WM_INPUTLANGCHANGE</a>&nbsp;to make it clear that they ain't always gonna work right....</font></font></p>
<p><font face=Tahoma></font>&nbsp;</p>
<p><font face=Tahoma color=#ff1493><em>This post brought to you by</em> "<font size=6>ꁖ</font>" <em>(<a href=http://www.fileformat.info/info/unicode/char/a056>U+a056</a>, a.k.a. YI SYLLABLE BBIT)</em></font></p>
<hr>
<p><a id=599071 href=#599071>#</a> <strong>Gabe</strong> on 16 May 2006 1:25 PM:<div style=margin-left:1em>Wow. That TSF is amazing! With 110 different interfaces, I can see why it could use a few more examples.
<br>
<br>It does look like it can be used to implement cool things like a system-wide spellchecker. I would *love* to see that as an example.</div>
<p><a id=599691 href=#599691>#</a> <strong>Martin Bohring</strong> on 17 May 2006 3:41 AM:<div style=margin-left:1em>Hello Michael,
<br>nice to see that quasi confirmed, because I have been bitten by that one in the past.
<br>
<br>It is nice to see IME / TSF based on a more modern foundation (COM), but there are more places where the documentation left something to be desired.
<br>
<br>There is a back compatibility layer, but sometimes it just proves that interfaces are leaky (semantical) even if not intended so.
<br>
<br>I came to the conclusion, that every interface definition is used in leaky way.</div>
<p><strong>Yuhong Bao</strong> on 11 Jul 2011 2:21 PM:<div style=margin-left:1em><p>What is funny is that I think the TSF can be installed on Win9x, which pretty much relies on double secret ANSI.</p>
</div>
<p><strong>Michael S. Kaplan</strong> on 11 Jul 2011 3:45 PM:<div style=margin-left:1em><p>It actually relies more on ANSI PLUS than double secret ANSI. :-)</p>
</div>
<p><strong>Yuhong Bao</strong> on 11 Jul 2011 6:53 PM:<div style=margin-left:1em><p>Of course, the breaking of the input language messages only applies to TSF text services, and I don't think the double secret ANSI support was ever extended to IMEs, partly because in Win9x only the DBCS versions had IME support. (NT 4.0 had an Pan-Chinese version that was English with IME support for both simplified and traditional Chinese)</p>
</div>
<p><strong>Yuhong Bao</strong> on 11 Jul 2011 6:59 PM:<div style=margin-left:1em><p>This reminds me of a bug while the original Office 2000 FM20.DLL and older versions would crash if you try to type with an IME that do not match the system codepage. Wonder if it is related to double secret ANSI.</p>
</div>
<hr><div style="float:right;padding:10;max-width:300;border:1px solid black;font-family:sans-serif;font-size:small">Please consider a <a href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=jan%2ekucera%40matfyz%2ecz&amp;lc=US&amp;item_name=Sorting%20It%20All%20Out%20Archive&amp;item_number=siao&amp;currency_code=EUR&amp;bn=PP%2dDonationsBF%3abtn_donate_LG%2egif%3aNonHosted" target=_blank>donation</a> to keep this archive running, maintained and free of advertising.<br>Donate €20 or more to receive an offline copy of the whole archive including all images.</div>
<p><em>referenced by</em><div style=margin-left:1em>
<p>2007/10/11 <a href=http://archives.miloush.net/michkap/archive/2007/10/11/5397051.html>Rumor as prophecy in Win32</a></p>
<p>2007/05/29 <a href=http://archives.miloush.net/michkap/archive/2007/05/29/2982638.html>Cutting the cord while someone else is shoring it up</a></p>
<p>2007/04/26 <a href=http://archives.miloush.net/michkap/archive/2007/04/26/2281645.html>Sprechen Sie IME?</a></p>
<p>2007/03/20 <a href=http://archives.miloush.net/michkap/archive/2007/03/20/1917161.html>Double Secret ANSI, part 2 (the brokenest one yet, sorry 'bout that!)</a></p>
<p>2006/07/13 <a href=http://archives.miloush.net/michkap/archive/2006/07/13/664497.html>IME + .NET = Input Madness Editor?</a></p></div>
<p><em>go to <a id=newer href=http://archives.miloush.net/michkap/archive/2006/05/16/599204.html title="Persian? Or Farsi?">newer</a> or <a id=older href=http://archives.miloush.net/michkap/archive/2006/05/15/598548.html title="Even if the message is not for you, you still need to pass it on">older</a> post, or back to <a href=http://archives.miloush.net/michkap/archive/index.html>index</a> or <a href=http://archives.miloush.net/michkap/archive/index.html#2006-05>month</a> or <a href=http://archives.miloush.net/michkap/archive/index.html#2006-05-16>day</a></em></p>